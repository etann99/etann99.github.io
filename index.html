<!DOCTYPE html>
<html lang="mg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rediredin'i Nantenaina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-base64/3.7.2/base64.min.js"></script>
    <style>
        html, body { 
            height: 100%; 
            margin: 0; 
            font-family: 'Inter', sans-serif; 
            background: rgba(230, 243, 230, 0.9); 
            color: #1A1A1A; 
        }
        body { 
            display: flex; 
            flex-direction: column; 
        }
        main { 
            flex: 1 0 auto; 
            padding-bottom: 100px; 
        }
        article { 
            font-family: 'Georgia', serif; 
            line-height: 1.8; 
        }
        .article-list img { 
            max-height: 200px; 
            object-fit: cover; 
        }
        header { 
            background-color: #5C2F2F; 
            color: white; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
        }
        footer { 
            background-color: #4A2C2A; 
            color: white; 
            flex-shrink: 0; 
        }
        a { 
            color: #5C2F2F; 
            transition: color 0.3s; 
        }
        a:hover { 
            color: #D4A017; 
        }
        .article-card { 
            transition: transform 0.2s; 
        }
        .article-card:hover { 
            transform: scale(1.02); 
        }
        .proverb { 
            font-style: italic; 
            color: #4A2C2A; 
        }
        select { 
            background: #5C2F2F; 
            color: white; 
            padding: 0.5rem; 
            border-radius: 0.25rem; 
        }
        #admin-form { 
            display: none; 
        }
        #admin-form.active { 
            display: block; 
        }
        input, textarea { 
            border: 1px solid #5C2F2F; 
            border-radius: 0.25rem; 
            padding: 0.5rem; 
            width: 100%; 
            margin-bottom: 1rem; 
        }
        textarea {
            white-space: pre-wrap;
        }
        button { 
            background-color: #5C2F2F; 
            color: white; 
            padding: 0.5rem 1rem; 
            border-radius: 0.25rem; 
            cursor: pointer; 
        }
        button:hover { 
            background-color: #D4A017; 
        }
        .delete-btn { 
            background-color: #B22222; 
        }
        .delete-btn:hover { 
            background-color: #8B0000; 
        }
        .modify-btn { 
            background-color: #FFA500; 
        }
        .modify-btn:hover { 
            background-color: #FF8C00; 
        }
    </style>
</head>
<body>
    <header class="shadow-md">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-4xl font-bold font-['Raleway', sans-serif]" data-lang-mg="Rediredin'i Nantenaina" data-lang-fr="Divagations de Nantenaina" data-lang-en="Nantenaina's Wanderings">Rediredin'i Nantenaina</h1>
            <p class="text-lg" data-lang-mg="Eritreritra na fihetseham-po sendra nandalo, dia nantsoina mba hitafa, dia noraketina an-tsoratra." data-lang-fr="Pensées ou émotions passantes, appelées à dialoguer, puis écrites." data-lang-en="Passing thoughts or emotions, called to converse, then written down.">Eritreritra na fihetseham-po sendra nandalo, dia nantsoina mba hitafa, dia noraketina an-tsoratra.</p>
            <nav class="mt-4 flex justify-between">
                <ul class="flex space-x-4">
                    <li><a href="index.html" class="hover:underline" data-lang-mg="Fandraisana" data-lang-fr="Accueil" data-lang-en="Home">Fandraisana</a></li>
                    <li><a href="about.html" class="hover:underline" data-lang-mg="Momba Ahy" data-lang-fr="À propos" data-lang-en="About">Momba Ahy</a></li>
                    <li><a href="contact.html" class="hover:underline" data-lang-mg="Hifandray" data-lang-fr="Contact" data-lang-en="Contact">Hifandray</a></li>
                </ul>
                <select id="lang-switcher" onchange="switchLanguage()">
                    <option value="mg">Malagasy</option>
                    <option value="fr">Français</option>
                    <option value="en">English</option>
                </select>
            </nav>
        </div>
    </header>
    <main class="container mx-auto px-4 py-8">
        <section class="mb-12">
            <p class="proverb mb-4">"Ny fanahy no maha olona" – Ohabolana Malagasy</p>
            <h2 class="text-2xl font-semibold mb-4" data-lang-mg="Lahatsoratra Rehetra" data-lang-fr="Tous les articles" data-lang-en="All Articles">Lahatsoratra Rehetra</h2>
            <div id="admin-form" class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 class="text-xl font-bold mb-4" id="form-title">Add New Article</h3>
                <input type="hidden" id="edit-id">
                <input type="password" id="admin-password" placeholder="Admin Password" required>
                <input type="text" id="article-title" placeholder="Article Title" required>
                <textarea id="article-content" placeholder="Article Content (use newlines for paragraphs)" rows="5" required></textarea>
                <input type="date" id="article-date" required>
                <input type="text" id="article-tags" placeholder="Tags (e.g., Fitiavana, Kolontsaina)">
                <input type="url" id="article-image" placeholder="Image URL">
                <button onclick="saveArticle()">Submit Article</button>
            </div>
            <div id="article-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Articles will be dynamically inserted here -->
            </div>
        </section>
    </main>
    <footer class="py-6">
        <div class="container mx-auto px-4">
            <p data-lang-mg="© 2025 Nantenaina Ratsimbazafy. Zo rehetra voatokana." data-lang-fr="© 2025 Nantenaina Ratsimbazafy. Tous droits réservés." data-lang-en="© 2025 Nantenaina Ratsimbazafy. All rights reserved.">© 2025 Nantenaina Ratsimbazafy. Zo rehetra voatokana.</p>
            <p data-lang-mg="Hifandraisa:" data-lang-fr="Contactez-moi :" data-lang-en="Connect:">Hifandraisa: <a href="mailto:elnantenaina99@gmail.com" class="hover:underline">elnantenaina99@gmail.com</a></p>
        </div>
    </footer>
    <script>
        // GitHub Personal Access Token (replace with your own)
        const githubToken = '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';
        // Hashed password for 'nantenaina2025' (bcrypt, 10 rounds)
        const hashedPassword = '$2a$10$3zX9z7X3X2z7X3u6z7X3X2.6z7X3X2z7X3u6z7X3X2z7X3u6z7X3X';
        // GitHub API endpoint for articles.json
        const repoUrl = 'https://api.github.com/repos/Etann99/Etann99.github.io/contents/articles.json';

        // Basic HTML sanitizer
        function sanitizeHTML(str) {
            return str.replace(/</g, '<').replace(/>/g, '>').replace(/"/g, '"').replace(/'/g, '');
        }

        function switchLanguage() {
            const lang = document.getElementById('lang-switcher').value;
            localStorage.setItem('selectedLanguage', lang);
            document.querySelectorAll('[data-lang-mg]').forEach(el => {
                el.textContent = el.getAttribute(`data-lang-${lang}`);
            });
            loadArticles();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('selectedLanguage') || 'mg';
            document.getElementById('lang-switcher').value = savedLang;
            document.querySelectorAll('[data-lang-mg]').forEach(el => {
                el.textContent = el.getAttribute(`data-lang-${savedLang}`);
            });

            // Show admin form if ?admin=true
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true') {
                document.getElementById('admin-form').classList.add('active');
            }

            // Load articles
            loadArticles();
        });

        async function fetchArticles() {
            try {
                const response = await fetch('articles.json');
                if (!response.ok) {
                    if (response.status === 404) {
                        console.warn('articles.json not found, returning empty array');
                        return [];
                    }
                    throw new Error(`Failed to fetch articles: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching articles:', error);
                alert('Failed to load articles. Check console for details.');
                return [];
            }
        }

        async function updateArticles(articles) {
            if (!githubToken || githubToken === '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') {
                alert('GitHub Personal Access Token is missing or invalid. Please update it in the code.');
                return false;
            }
            try {
                // Fetch current articles.json to get SHA
                let sha;
                try {
                    const getResponse = await fetch(repoUrl, {
                        headers: { 'Authorization': `token ${githubToken}` }
                    });
                    if (getResponse.status === 404) {
                        // File doesn't exist, create new
                        sha = null;
                    } else if (!getResponse.ok) {
                        throw new Error(`Failed to fetch articles.json: ${getResponse.statusText}`);
                    } else {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }
                } catch (error) {
                    if (error.message.includes('404')) {
                        sha = null;
                    } else {
                        throw error;
                    }
                }

                // Update articles.json
                const content = Base64.encode(JSON.stringify(articles, null, 2));
                const response = await fetch(repoUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update articles.json at ${new Date().toISOString()}`,
                        content: content,
                        sha: sha || undefined
                    })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to update articles: ${errorData.message || response.statusText}`);
                }
                return true;
            } catch (error) {
                console.error('Error updating articles:', error);
                alert(`Failed to update articles: ${error.message}. Check console for details.`);
                return false;
            }
        }

        async function saveArticle() {
            const password = document.getElementById('admin-password').value;
            if (!password) {
                alert('Please enter a password.');
                return;
            }
            if (!bcrypt.compareSync(password, hashedPassword)) {
                alert('Incorrect password.');
                return;
            }

            const id = document.getElementById('edit-id').value ? parseInt(document.getElementById('edit-id').value) : null;
            const title = sanitizeHTML(document.getElementById('article-title').value);
            const content = document.getElementById('article-content').value;
            const date = document.getElementById('article-date').value;
            const tags = document.getElementById('article-tags').value.split(',').map(tag => sanitizeHTML(tag.trim())).filter(tag => tag);
            const image = document.getElementById('article-image').value || 'https://mta.mg/wp-content/uploads/2021/05/Sunset-baobabs-Madagascar-mta-1.jpg';

            if (!title || !content || !date) {
                alert('Please fill in title, content, and date.');
                return;
            }

            const articles = await fetchArticles();
            if (id) {
                // Update existing article
                articles.forEach(article => {
                    if (article.id === id) {
                        article.title = title;
                        article.content = content;
                        article.date = date;
                        article.tags = tags;
                        article.image = image;
                    }
                });
            } else {
                // Add new article
                const newId = articles.length ? Math.max(...articles.map(a => a.id)) + 1 : 1;
                articles.push({ id: newId, title, content, date, tags, image });
            }
            const success = await updateArticles(articles);
            if (success) {
                // Reset form
                document.getElementById('form-title').textContent = 'Add New Article';
                document.getElementById('edit-id').value = '';
                document.getElementById('admin-password').value = '';
                document.getElementById('article-title').value = '';
                document.getElementById('article-content').value = '';
                document.getElementById('article-date').value = '';
                document.getElementById('article-tags').value = '';
                document.getElementById('article-image').value = '';
                loadArticles();
            }
        }

        async function modifyArticle(id) {
            const password = prompt('Enter admin password to modify article:');
            if (!password) {
                alert('Please enter a password.');
                return;
            }
            if (!bcrypt.compareSync(password, hashedPassword)) {
                alert('Incorrect password.');
                return;
            }

            const articles = await fetchArticles();
            const article = articles.find(a => a.id === id);
            if (article) {
                document.getElementById('form-title').textContent = 'Modify Article';
                document.getElementById('edit-id').value = article.id;
                document.getElementById('article-title').value = article.title;
                document.getElementById('article-content').value = article.content;
                document.getElementById('article-date').value = article.date;
                document.getElementById('article-tags').value = article.tags.join(', ');
                document.getElementById('article-image').value = article.image;
                document.getElementById('admin-form').classList.add('active');
                window.scrollTo(0, document.getElementById('admin-form').offsetTop);
            }
        }

        async function deleteArticle(id) {
            const password = prompt('Enter admin password to delete article:');
            if (!password) {
                alert('Please enter a password.');
                return;
            }
            if (!bcrypt.compareSync(password, hashedPassword)) {
                alert('Incorrect password.');
                return;
            }

            const articles = await fetchArticles();
            const updatedArticles = articles.filter(article => article.id !== id);
            const success = await updateArticles(updatedArticles);
            if (success) {
                loadArticles();
            }
        }

        async function loadArticles() {
            const articles = await fetchArticles();
            const articleList = document.getElementById('article-list');
            articleList.innerHTML = '';
            const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'true';
            const lang = document.getElementById('lang-switcher').value || 'mg';

            articles.forEach(article => {
                const articleDiv = document.createElement('div');
                articleDiv.className = 'bg-white p-6 rounded-lg shadow-md article-card';
                const excerpt = article.content.substring(0, 100).replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
                articleDiv.innerHTML = `
                    <img src="${article.image}" alt="Article image" class="w-full mb-4 rounded">
                    <h3 class="text-xl font-bold"><a href="article.html?id=${article.id}" class="hover:underline">${article.title}</a></h3>
                    <p class="text-gray-500 text-sm">${new Date(article.date).toLocaleDateString('mg-MG')}</p>
                    <div class="mt-2" style="white-space: pre-wrap;"><p>${excerpt}${article.content.length > 100 ? '...' : ''}</p></div>
                    <p class="text-sm text-gray-600" data-lang-mg="Tenifototra" data-lang-fr="Étiquettes" data-lang-en="Tags">${lang === 'mg' ? 'Tenifototra' : lang === 'fr' ? 'Étiquettes' : 'Tags'}: ${article.tags.join(', ') || 'Tsia'}</p>
                    <div class="mt-2">
                        <a href="https://twitter.com/intent/tweet?url=https://Etann99.github.io/article.html?id=${article.id}&text=${encodeURIComponent(article.title)}" class="text-sm text-blue-600 hover:underline">Share on X</a> |
                        <a href="mailto:?subject=${encodeURIComponent(article.title)}&body=Check out this article: https://Etann99.github.io/article.html?id=${article.id}" class="text-sm text-blue-600 hover:underline">Share via Email</a>
                    </div>
                    <a href="article.html?id=${article.id}" class="hover:underline">Hamaky Bebe Kokoa</a>
                    ${isAdmin ? `
                        <div class="mt-2 space-x-2">
                            <button class="modify-btn" onclick="modifyArticle(${article.id})">Modify</button>
                            <button class="delete-btn" onclick="deleteArticle(${article.id})">Delete</button>
                        </div>
                    ` : ''}
                `;
                articleList.appendChild(articleDiv);
            });
        }
    </script>
</body>
</html>
